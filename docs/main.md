# Главная страница - Логика работы

## При открытии Mini App

1. Telegram передает данные пользователя (`telegram_id`, `username`, `first_name`)
2. Backend проверяет: пользователь существует?
   - **Нет** → создается новая запись с балансом 0₽
   - **Да** → загружаются данные существующего пользователя
3. Если в URL был реферальный код `?start=ref_XXXXX` → записывается реферер
4. Загружается и отображается баланс (main_balance + referral_balance)

---

## Карточка "Ваш баланс"

### Отображение
- Показывает сумму основного и реферального балансов вместе
- Формат: "150 ₽"

### Кнопка "Вывести"

**Что происходит:**
1. Проверка: если баланс < 100₽ → показать ошибку "Минимум для вывода 100₽"
2. Открывается модальное окно вывода средств

---

# Модальное окно вывода средств

## Что видит пользователь:

### 1. Шапка
- Drag handle (полоска для свайпа вниз)
- Заголовок: "Вывод средств"
- Кнопка закрытия (X)

### 2. Блок суммы вывода
- Поле ввода: "Сумма для вывода"
- Справа: "На балансе: 5 000 ₽" (текущий баланс пользователя)
- Ссылка "Вывести всю сумму" (оранжевая, подчеркнутая)

### 3. Переключатель способа вывода
- Заголовок: "Способ вывода"
- Два варианта (toggle):
  - **"Банковская карта"** (выбран по умолчанию)
  - **"СБП"**

### 4. Поля реквизитов (меняются в зависимости от способа)

**Вариант A: Банковская карта**
- Поле "Номер карты": "0000 0000 0000 0000"
- Поле "ФИО получателя": "Иванов Иван Иванович"

**Вариант B: СБП**
- Dropdown "Банк получателя": Сбербанк, Тинькофф, Альфа-Банк и др.
- Поле "Номер телефона": "+7 (999) 999-99-99"

### 5. Блок итоговой суммы
- "К зачислению: 4 500 ₽"

### 6. Кнопка отправки
- "Отправить заявку" (оранжевая, широкая)

---

## Логика действий:

### При открытии модалки
- Баланс берется с главной страницы
- Поле суммы пустое (плейсхолдер "0 ₽")
- По умолчанию выбрана "Банковская карта"

### Ссылка "Вывести всю сумму"
- Автоматически заполняет поле текущим балансом

### Переключение способа вывода

**При клике "Банковская карта":**
- Показываются: Номер карты + ФИО получателя
- Скрываются поля СБП

**При клике "СБП":**
- Показываются: Банк получателя + Номер телефона
- Скрываются поля карты

### Кнопка "Отправить заявку"

**Валидация:**
- Сумма >= 100₽ (минимум)
- Сумма <= текущий баланс
- Для карты: номер карты (16 цифр) + ФИО заполнены
- Для СБП: банк выбран + номер телефона заполнен

**Если ошибка:**
- Показать текст ошибки под полем

**При успехе:**
- Создается заявка в БД со статусом "pending"
- Сохраняются: сумма, способ, реквизиты
- Модалка закрывается
- Уведомление: "Заявка отправлена на модерацию"
- **Баланс НЕ вычитается** (только после одобрения админом)

### Закрытие модалки
- Кнопка X или свайп вниз
- Введенные данные НЕ сохраняются

---

## Кнопка "Работа с задачами"

**Что происходит:**
1. Переход на страницу `/tasks`

---

# Страница "Работа с задачами"

## Что видит пользователь:

### 1. Блок "Получить новую задачу"
- **Индикатор лимита:** Круговая диаграмма "7/10"
  - Показывает сколько задач взято сегодня из максимальных 10
- **Две кнопки выбора типа задачи:**
  - **"Обычная задача - 50₽"** - отправить сообщение, дождаться прочтения (две галочки)
  - **"Задача с номером - 150₽"** - получить телефон продавца в переписке
  - ⚠️ **Важно:** Цены (50₽ / 150₽) загружаются с бэкенда из конфигурации

### 2. Список активных задач
Карточки задач, которые пользователь уже взял, но еще не завершил.

**На каждой карточке:**
- ID задачи (например: #A8B12, #C7D45)
- Тип задачи (Обычная / С номером)
- Таймер обратного отсчета: "23ч 15м осталось" (из 24 часов)
- Прогресс-бар с цветом по срочности:
  - **Зеленый:** >20 часов осталось (95% времени)
  - **Желтый:** 8-20 часов осталось (35-80% времени)
  - **Красный:** <8 часов осталось (менее 35% времени)

## Логика действий:

### При нажатии кнопки "Обычная задача" или "Задача с номером"

1. **Проверка дневного лимита:**
   - Если взято 10 задач → показать ошибку "Достигнут дневной лимит задач на сегодня"
   - Заблокировать кнопку

2. **Показ модального окна подтверждения:**
   - Тип задачи (Обычная / С номером)
   - Награда (50₽ / 150₽) - **приходит с бэкенда из конфига**
   - Время на выполнение: 24 часа
   - Кнопки: "Отменить" / "Взять задачу"

3. **При подтверждении "Взять задачу":**
   - Задача блокируется на этого пользователя на 24 часа
   - Другие пользователи больше не видят эту задачу в доступных
   - Задача добавляется в список активных задач
   - Счетчик лимита увеличивается (7/10 → 8/10)
   - Стартует таймер обратного отсчета 24 часа

### При клике на карточку активной задачи

**Переход на страницу деталей задачи** `/tasks/:task_id`

---

# Страница деталей одной задачи

## Что видит пользователь:

### 1. Шапка
- Кнопка "Назад" (стрелка влево)
- ID задачи: "Задача #12345"

### 2. Блок таймера
- Тип задачи: "Обычная" или "С номером" (приходит с бэкенда)
- Осталось времени: "01:23:45" (обновляется каждую секунду)
- Дедлайн: "25.12.2024 в 23:59"

### 3. Блок вознаграждения
- Сумма: "250 ₽" ⚠️ **приходит с бэкенда из конфига**

### 4. Блок инструкций
- Заголовок: "Инструкция"
- Пошаговый текст (4 шага) ⚠️ **приходит с бэкенда из конфига**
- Кнопка: "Скопировать ссылку на объявление Avito"

### 5. Блок текста для отправки
- Заголовок: "Текст для отправки продавцу"
- Готовый текст ⚠️ **приходит с бэкенда** (из задачи)
- Кнопка копирования (иконка)

### 6. Блок подтверждения (только для типа "С номером")
- Заголовок: "Подтверждение"
- Поле ввода: "+7 (999) 000-00-00"
- **Для обычных задач этого блока НЕТ**

### 7. Блок загрузки скриншотов
- Заголовок: "Загрузка скриншотов"
- Подзаголовок: "Загрузите до 5 скриншотов"
- Сетка превью (3 колонки)
- Загруженные изображения с кнопкой удаления (X)
- Кнопка "Добавить" (пунктирная рамка)

### 8. Footer (зафиксирован внизу)
- Кнопка "Отправить на модерацию" (золотая)
- Кнопка "Отказаться от задачи" (серая)

---

## Логика действий:

### Кнопка "Назад"
- Возврат на `/tasks`

### Таймер обратного отсчета
- Вычисляется: `дедлайн - текущее время`
- Обновляется каждую секунду на фронтенде
- При истечении → задача автоматически возвращается в пул

### Кнопка "Скопировать ссылку на объявление Avito"
- Копирует URL объявления в буфер обмена
- Показывает уведомление: "Ссылка скопирована"

### Кнопка копирования текста
- Копирует текст сообщения в буфер обмена
- Показывает уведомление: "Текст скопирован"

### Поле номера телефона
- Отображается только для типа "С номером"
- Валидация: российский формат +7

### Загрузка скриншотов

**При клике "Добавить":**
- Открывается выбор файла (изображения)
- Максимум 5 скриншотов
- Если лимит → ошибка "Максимум 5 скриншотов"
- Загрузка на сервер
- Превью в сетке

**При клике "Удалить" (X):**
- Удаление из списка
- Удаление с сервера

### Кнопка "Отправить на модерацию"

**Проверки:**
- Минимум 1 скриншот загружен
- Для типа "С номером": номер заполнен

**При успехе:**
- Статус → "submitted"
- Сохранение скриншотов и номера в БД
- Уведомление: "Задача отправлена на модерацию (~2 часа)"
- Переход на `/tasks`
- Задача исчезает из активных

### Кнопка "Отказаться от задачи"

**Подтверждение:** "Вы уверены?"

**При подтверждении:**
- Отвязка от пользователя
- Возврат в пул доступных задач
- Удаление загруженных скриншотов
- Переход на `/tasks`

### Автоматическое возвращение задачи

Если задача не отправлена на модерацию за 24 часа:
- Задача автоматически отвязывается от пользователя
- Возвращается в общий пул доступных задач
- Удаляется из активных задач пользователя
- Счетчик лимита НЕ уменьшается (лимит на день остается)

---

## Кнопка "Реферальная программа"

**Что происходит:**
1. Переход на страницу `/referrals`

---

# Страница реферальной программы

## Что видит пользователь:

### 1. Шапка
- Кнопка "Назад" (стрелка влево)
- Заголовок: "Реферальная программа"
- Кнопка помощи (иконка вопроса)

### 2. Блок реферальной ссылки
- Заголовок: "Ваша уникальная ссылка"
- Ссылка: "avito-tasker.ru/ref/user123"
- Кнопка "Копировать" (с иконкой)

### 3. Статистика (2 карточки в ряд)
- **Левая:** "Приглашено друзей" → "12"
- **Правая:** "Ваш заработок" → "1 250 ₽" (золотой цвет)

### 4. Список рефералов
- Заголовок: "Ваши рефералы"
- Карточки каждого реферала:
  - ID: "ID 12345678"
  - Статистика: "Обычные: 8, С номером: 2"
  - Заработок: "+ 120 ₽" (золотой)

### 5. Empty state (если нет рефералов)
- Иконка группы
- Текст: "Пока нет рефералов"
- Подсказка: "Поделитесь ссылкой с друзьями и начните зарабатывать вместе!"

---

## Логика действий:

### При загрузке страницы
Запрашиваются данные с бэкенда:
- Реферальная ссылка (на основе `telegram_id`)
- Количество рефералов
- Общий заработок
- Список рефералов с детализацией

### Кнопка "Назад"
- Возврат на главную `/`

### Кнопка помощи (?)
- Модальное окно или tooltip с объяснением:
  - Как работает программа
  - Процент начислений (50% от заработка реферала)
  - Как пригласить друга

### Кнопка "Копировать"
- Копирует ссылку в буфер обмена
- Уведомление: "Ссылка скопирована"

### Формирование ссылки
- Формат: `https://t.me/avito_tasker_bot?start=ref_TELEGRAM_ID`
- `TELEGRAM_ID` - это telegram_id реферера

### Регистрация реферала
**При переходе по ссылке нового пользователя:**
1. Telegram открывает бота с `start=ref_XXXXXX`
2. При первой авторизации сохраняется `referred_by = XXXXXX`
3. В БД создается связь реферер → реферал

### Начисление бонусов
**При одобрении задачи реферала:**
1. Реферал выполнил задачу → одобрено → начислено 100₽
2. Вычисляется комиссия (50% = 50₽)
3. Увеличивается `referral_balance` реферера
4. Создается запись в `referral_earnings`
5. Обновляется счетчик "Ваш заработок"

### Список рефералов
**Для каждого показывается:**
- Telegram ID (без имени для приватности)
- Количество задач: Обычные + С номером
- Заработок от реферала

**Сортировка:** по убыванию заработка

### Empty state
**Показывается если:**
- Нет рефералов (список пуст)
- Скрывается блок "Ваши рефералы"
- Показывается иконка + мотивационный текст

---

## Блок "Как это работает?"

- Статичный информационный блок
- Объясняет суть сервиса новым пользователям
- Не интерактивный (просто текст)

---

## Кнопка "Поддержка" (footer)

**Что происходит:**
1. Открывается Telegram чат с модератором
2. Пользователь может написать вопрос напрямую
3. Mini App остается в фоне

---

## Обновление баланса

**Баланс обновляется:**
- При каждом возврате на главную страницу
- После одобрения выполненной задачи модератором
- После начисления реферальной комиссии
- После одобрения вывода средств админом

---

## Логика безопасности

- Пользователь видит только СВОЙ баланс
- Все действия привязаны к `telegram_id` из сессии
- Нельзя запросить данные другого пользователя
- Вывод средств: проверка минимума и достаточности баланса
